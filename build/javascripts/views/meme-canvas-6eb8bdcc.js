MEME.MemeCanvasView=Backbone.View.extend({initialize:function(){var t=document.createElement("canvas"),e=MEME.$("#meme-canvas");t&&t.getContext?(e.html(t),this.canvas=t,this.setDownload(),this.render()):e.html(this.$("noscript").html()),this.listenTo(this.model,"change",this.render)},setDownload:function(){var t=document.createElement("a");"undefined"==typeof t.download&&this.$el.append('<p class="m-canvas__download-note">Right-click button and select "Download Linked File..." to save image.</p>')},render:function(){function t(t){var e=l.background.height,i=l.background.width;if(e&&i){var a=e*r.imageScale,n=i*r.imageScale,o=r.backgroundPosition.x||r.width/2,h=r.backgroundPosition.y||r.height/2;t.drawImage(l.background,0,0,i,e,o-n/2,h-a/2,n,a)}}function e(t){return l.background.height>0?!1:void(r.backgroundColor&&(t.fillStyle=r.backgroundColor,t.fillRect(0,0,r.width,r.height)))}function i(t){r.overlayColor&&(t.save(),t.globalAlpha=r.overlayAlpha,t.fillStyle=r.overlayColor,t.fillRect(0,0,r.width,r.height),t.globalAlpha=1,t.restore())}function a(t){var e=Math.round(.75*r.width),i=s,a=s;t.font=r.fontSize+"pt "+r.fontFamily,t.fillStyle=r.fontColor,t.textBaseline="top",r.textShadow&&(t.shadowColor="black",t.shadowOffsetX=-2,t.shadowOffsetY=1,t.shadowBlur=10),"center"==r.textAlign?(t.textAlign="center",i=r.width/2,a=r.height-r.height/1.15,e=r.width-r.width/3):"right"==r.textAlign?(t.textAlign="right",i=r.width-s):t.textAlign="left";var n=1.5,o=r.headlineText.split(" "),o=_.filter(o,function(t){return""!=t}),h=/\r|\n/,l=[];_.each(o,function(t){if(h.exec(t)){var e=t.split(h);_.each(e,function(t,i){l.push(t),i+1!=e.length&&l.push("\n")})}else l.push(t)});var l=_.filter(l,function(t){return""!=t}),d="";_.each(l,function(o,h){if("\n"==o)t.fillText(d,i,a),d="",a+=Math.round(r.fontSize*n);else{var l=d+o+" ",s=t.measureText(l),c=s.width;c>e&&h>0?(t.fillText(d,i,a),d=o+" ",a+=Math.round(r.fontSize*n)):d=l}}),t.fillText(d,i,a),t.shadowColor="transparent"}function n(t){var e=Math.round(.5*r.width),i=s,a=s;t.font=r.TextSize+"pt "+r.fontFamily,t.fillStyle=r.fontColor,t.textBaseline="middle",r.textShadow&&(t.shadowColor="black",t.shadowOffsetX=-2,t.shadowOffsetY=1,t.shadowBlur=10),"center"==r.textAlign?(t.textAlign="center",i=r.width/2,a=r.height-r.height/1.5,e=r.width-r.width/3):"right"==r.textAlign?(t.textAlign="right",i=r.width-s,a=r.height-r.height/1.5):(t.textAlign="left",a=r.height-r.height/1.5);var n=1.2,o=r.MainText.split(" "),o=_.filter(o,function(t){return""!=t}),h=/\r|\n/,l=[];_.each(o,function(t){if(h.exec(t)){var e=t.split(h);_.each(e,function(t,i){l.push(t),i+1!=e.length&&l.push("\n")})}else l.push(t)});var l=_.filter(l,function(t){return""!=t}),d="";_.each(l,function(o,h){if("\n"==o)t.fillText(d,i,a),d="",a+=Math.round(r.fontSize*n);else{var l=d+o+" ",s=t.measureText(l),c=s.width;c>e&&h>0?(t.fillText(d,i,a),d=o+" ",a+=Math.round(r.fontSize*n)):d=l}}),t.fillText(d,i,a),t.shadowColor="transparent"}function o(t){t.textBaseline="bottom",t.textAlign="left",t.fillStyle=r.fontColor,t.font="normal 14pt Graphik",t.fillText(r.creditText,s,r.height-s)}function h(t){var e,i,a,n;if(i=n=l.watermark.height,e=a=l.watermark.width,i&&e){var o=r.width*r.watermarkMaxWidthRatio;e>o&&(n=i*(o/e),a=o),t.globalAlpha=r.watermarkAlpha,t.drawImage(l.watermark,0,0,e,i,r.width-s-a,r.height-s-n+72,1272,n),t.globalAlpha=1}}if(this.canvas){var l=this.model,r=this.model.toJSON(),d=this.canvas.getContext("2d"),s=Math.round(r.width*r.paddingRatio);this.canvas.width=r.width,this.canvas.height=r.height,d.clearRect(0,0,r.width,r.height),t(d),e(d),i(d),a(d),n(d),o(d),h(d);var c=this.canvas.toDataURL();this.$("#meme-download").attr({href:c,download:(r.downloadName||"share")+".png"}),this.canvas.style.cursor=this.model.background.width?"move":"default"}},events:{"mousedown canvas":"onDrag"},onDrag:function(t){function e(t){t.preventDefault(),i.set("backgroundPosition",{x:Math.max(a.width-n,Math.min(l.x-(h.x-t.clientX),n)),y:Math.max(a.height-o,Math.min(l.y-(h.y-t.clientY),o))})}if(t.preventDefault(),this.model.hasBackground()){var i=this.model,a=i.toJSON(),n=i.background.width*a.imageScale/2,o=i.background.height*a.imageScale/2,h={x:t.clientX,y:t.clientY},l=a.backgroundPosition;l.x=l.x||a.width/2,l.y=l.y||a.height/2;var r=MEME.$(document).on("mousemove.drag",e).on("mouseup.drag",function(t){r.off("mouseup.drag mousemove.drag"),e(t)})}}});